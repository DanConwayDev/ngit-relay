<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <title>ngit-relay Instance</title>
    <meta name="description" content="A pure HTML example, without dependencies.">

    <!-- Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.1.1/css/pico.min.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            text-align: center;
            min-height: 100vh;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        footer {
            padding: 1rem;
            width: 100%;
            margin-top: auto;
        }

        .learn-more-section {
            padding: 1rem;
            text-align: center;
            width: 100%;
        }
    </style>
</head>

<body>
    <main class="container">
        <h2><span id="dynamic-host"></span> <span style="margin: 0 0.5rem; opacity:0.4">ngit-relay instance</span></h2>
        <p>Nostr-permissioned Git/Relay/Blossom server</p>
        <p>
            Browse <span id="link-repo-ref-text"></span> with a <a id="repolink" href="https://gitworkshop.dev/relay/[inserthosthere]">Git Nostr client like this</a>
        </p>
    </main>
    <div class="learn-more-section">
        <a href="https://ngit.dev/relay">Learn more</a>
    </div>
<footer
    style="padding: 1.5rem 0; margin-top: auto; width: 100%; background-color: rgba(0,0,0,0.1);">
    <div class="container">
        <div style="text-align: center;">
            <small>
                <span id="dynamic-host-footer"></span>
                <span style="margin: 0 0.5rem;">•</span>
                <span>v<span id="relayversion"></span></span>
                <span style="margin: 0 0.5rem;">•</span>
                <a href="https://gitworkshop.dev/danconwaydev.com/ngit-relay">source</a>
                <span style="margin: 0 0.5rem;">•</span>
                <span>MIT Licensed</span>
            </small>
        </div>
    </div>
</footer>
    <script>
        // Get the current location details
        const protocol = window.location.protocol; // 'http:' or 'https:'
        const host = window.location.host; // 'domain.com' or 'sub.domain.com:port'
        let relayref = host;
        if (protocol === 'http:') relayref = encodeURIComponent("ws://" + host);


        // Update the dynamic host in the header
        document.getElementById('dynamic-host').innerText = host;
        document.getElementById('dynamic-host-footer').innerText = host;

        const repolink = document.getElementById('repolink');
        let linkSet = false; // Flag to track if the link has been set

        // Get the path part of the URL (e.g., "/npub123/identifier.git")
        const urlPath = window.location.pathname;

        // Check if the current URL path ends with '.git'
        if (urlPath.endsWith('.git')) {
            // Remove the '.git' postfix from the path
            const pathWithoutGit = urlPath.slice(0, -4); // e.g., "/npub123/identifier"

            // Split the path into segments and filter out any empty strings (e.g., from leading slash)
            const segments = pathWithoutGit.split('/').filter(s => s !== '');

            // We expect at least two segments: the npub part and the identifier part,
            // which should be the last two segments in the path relative to the domain.
            if (segments.length >= 2) {
                const npubPart = segments[segments.length - 2];   // e.g., "npub123"
                const identifierPart = segments[segments.length - 1]; // e.g., "identifier"

                // Verify that the detected 'npubPart' actually starts with 'npub1'
                if (npubPart.startsWith('npub1')) {
                    // Construct the new GitWorkshop link as per the format:
                    // gitworkshop.dev/npub123/relayref/identifier
                    // Here, 'relayref' is the current 'host' of the page.
                    repolink.setAttribute('href', `https://gitworkshop.dev/${npubPart}/${relayref}/${identifierPart}`);
                    document.getElementById('link-repo-ref-text').innerText = `${identifierPart} repository`;
                    linkSet = true;
                }
            }
        }

        // If the repolink was not set by the specific '.git' condition,
        // fall back to the original default "relay/[inserthosthere]" format.
        if (!linkSet) {
            repolink.setAttribute('href', `https://gitworkshop.dev/relay/${relayref}`);
            document.getElementById('link-repo-ref-text').innerText = "repositories";
        }


        // Function to fetch relay information and set the version to an element by ID
        function fetchRelayVersion(endpoint, elementId) {
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Accept': 'application/nostr+json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // Parse the JSON from the response
                })
                .then(data => {
                    const version = data.version; // Get the version from the relay info
                    const element = document.getElementById(elementId); // Get the element by ID
                    if (element) {
                        element.textContent = version; // Set the text content to the relay version
                    } else {
                        console.error(`Element with ID "${elementId}" not found.`);
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Example usage: Fetch the version from the endpoint and set it to an element with ID "relayVersion"
        fetchRelayVersion('/', 'relayversion');
    </script>
</body>

</html>